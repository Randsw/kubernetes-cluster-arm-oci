- name: Install Flux
  command: curl -s https://fluxcd.io/install.sh | sudo bash

- name: Create gpg key for flux
    shell: 
      cmd: | 
        gpg --batch --full-generate-key <<EOF
        %no-protection
        Key-Type: 1
        Key-Length: 4096
        Subkey-Type: 1
        Subkey-Length: 4096
        Expire-Date: 0
        Name-Comment: {{ KEY_COMMENT}}
        Name-Real: {{ KEY_NAME }}
        EOF

- name: Get key FP
    command: "gpg --list-secret-keys {{ KEY_NAME }}"
    register: gpg_fp_out

- name: Debug gpg_fp
  set_fact:
        gpg_fp: "{{ gpg_fp_out.stdout_lines[1] | trim }}"

- name: Create namespace for flux
  command: kubectl create namespace flux-system --dry-run=client -o yaml | kubectl apply -f - 

- name: Create SOPS secret in flux-system namespace
  shell: | 
        'gpg --export-secret-keys --armor "{{ gpg_fp }}" |
         kubectl create secret generic sops-gpg \
         --namespace=flux-system \
         --from-file=sops.asc=/dev/stdin'

- name: Deploy Flux
  command: kubectl apply --kustomize=./cluster/base/flux-system